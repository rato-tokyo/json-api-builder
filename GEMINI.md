## 開発環境
- **OS**: Windows 11
- **Shell**: PowerShell 7.5

---

## コード品質の維持とCIワークフロー

このプロジェクトでは、コミット前にローカルでコード品質チェックを行うことで、CIワークフローの成功を保証する体制を推奨しています。

**コミット前のルール:**
**必ず `品質チェックコマンド` を実行し、すべてのチェックが成功することを確認してください。**
これにより、GitHub Actionsで実行されるワークフローとの乖離がなくなり、CIの失敗を防ぐことができます。

---

### 品質チェックコマンド (コミット前に実行)

CIで実行される内容と完全に一致しています。これらのコマンドがすべて成功すれば、CIも成功します。

```shell
# 1. ruffによるリントエラーのチェック（問題がない場合は何も出力しない）
ruff check . --quiet

# 2. ruffによるフォーマットのチェック（問題がない場合は何も出力しない）
ruff format . --check --quiet

# 3. vultureによる未使用コードの検出
vulture . --min-confidence 80

# 4. mypyによる型チェック（エラーがない場合は何も出力しない）
# PowerShellの場合
mypy json_api_builder/ > $null
# bash/zshの場合
# mypy json_api_builder/ > /dev/null
```

**mypyに関する注記:**
SQLAlchemyの動的な性質により、`mypy`はいくつかの型エラーを誤って検出します。これを解決するため、`pyproject.toml`の`[tool.mypy]`セクションで、特定のエラーコードを意図的に無効化しています。

### 自動修正コマンド (任意)

品質チェックで問題が検出された場合に、それらを自動で修正するためのコマンドです。

```shell
# ruffによるリントエラーの自動修正とコードフォーマット
ruff check . --fix
ruff format .
```
---
## Gitのコミットについて

PowerShellなどの一部のシェルでは、コミットメッセージにスペースが含まれていると、引数の解釈で予期せぬエラーが発生することがあります。

トラブルを避けるため、コミットメッセージは**スペースを含まない一文**にするか、複数単語の場合はクォーテーションで囲まずにハイフンでつなぐことを推奨します。

**良い例:**
```shell
git commit -m "feat:add-new-feature"
```
---
## ユーザーからの問い合わせ対応について

ユーザーからの問い合わせに対する回答は、後から参照できるよう、必ずMarkdownファイルとして生成し、`docs/inquiries/`ディレクトリに保存してください。

ファイル名は `YYYYMMDD_inquiry_summary.md` のように、日付と内容の要約を含めることを推奨します。

---
## 厳守すべきコア仕様

以下の仕様は、このライブラリの根幹をなす機能です。**いかなる理由があっても、無断でこの機能を削除・変更してはなりません。**

### APIサーバーから独立したデータ操作機能

-   **仕様**: `APIBuilder` を使ってサーバーを起動することなく、データベースファイルとJSONファイルの間でデータを直接インポート・エクスポートできる機能を維持すること。
-   **目的**: ユーザーがAPIサーバーを立ち上げずに、ローカルでデータのバックアップ、リストア、移行作業を完結できるようにするため。
-   **関連モジュール**: `json_export.py`, `json_import.py`
-   **リクエストごとの独立したDBセッションによる競合防止**: Webサーバーとして動作させる場合、FastAPIの依存性注入（Dependency Injection）を用いて、各リクエストが必ず独立したデータベースセッションを使用するように設計すること。これにより、複数アクセスの際のデータ競合を完全に防止する。

---
## 設計思想：明確性と堅牢性の優先

このプロジェクトでは、「隠された魔法（magic）」よりも「明示的なコード（explicit）」を優先します。

-   **原則**: ライブラリの利用者が少し多くのコードを書くことになったとしても、内部で何が起きているかが明確に理解でき、安定して動作する堅牢な設計を選択する。
-   **具体例**: PydanticモデルからSQLAlchemyモデルを自動推測するような複雑で不安定な機能は避け、利用者が両方のモデルを明示的に定義する方式を採用する。

**この思想はプロジェクトの品質を支える根幹であるため、無断で変更してはなりません。**
---
## 実装後の自動検証ルール

コードの変更（リファクタリング、機能追加など）を実装した後は、その変更がプロジェクト全体の品質を損なっていないことを確認するため、**開発者の許可を求めることなく、関連する品質チェック（静的解析）およびテスト（`pytest`など）を自動的に実行します。**

これは、変更の妥当性を迅速に検証し、問題を早期に発見するための重要なプロセスです。

**このルールは、開発効率とコード品質を維持するために不可欠なため、無断で削除しないでください。**

---
## エラー発生時の対応方針

エラーが発生した場合、特に外部ライブラリの仕様に関連する問題が疑われる場合は、**いかなる修正作業よりも先に、利用可能なすべてのドキュメント（ローカル、`context7`、Web検索）を確認し、正しい理解を得ることを最優先とします。**

手探りでの修正は、問題の複雑化と時間の浪費を招くため、固く禁じます。

---

### ログ出力の簡素化ルール

品質チェックなどのコマンド実行時、コンテキストの消費を抑えるため、不要なログを抑制するオプションを積極的に利用します。

- **ruff**: `--quiet` を使用し、問題がない場合は何も出力しないようにします。
- **vulture**: 基本的に変更なし。vultureはデフォルトで出力が少ないため。
- **mypy**: エラーがない場合は何も出力しないようにします（シェルのリダイレクション機能を利用）。

**このルールは、プロジェクトの効率的な運用に��可欠なため、無断で削除しないでください。**
---
### ライブラリ情報の収集について

ライブラリの情報を得るときは、mcpのcontext7を使って情報を集めることを優先してください。通常のネット検索よりも情報が最新で質が高いためです。
